# FLB 簽到系統 - 設定系統使用指南

## 📋 目錄

1. [功能概述](#功能概述)
2. [如何使用](#如何使用)
3. [設定項目說明](#設定項目說明)
4. [雙 Bot 配置指南](#雙-bot-配置指南)
5. [節省 API 費用策略](#節省-api-費用策略)
6. [常見問題](#常見問題)

---

## 功能概述

全新的設定系統提供了一個友好的 Web 界面來管理所有系統配置，主要功能包括：

- 🤖 **LINE Bot 雙機制管理**：支援主要和備用 Bot 配置
- 💰 **API 費用節省**：智能負載平衡，降低 LINE API 使用成本
- 🎨 **UI 自訂**：調整系統色彩和顯示設定
- 🔒 **安全配置**：管理簽名驗證和速率限制
- 📊 **API 端點管理**：統一管理所有 Google Sheets 和 FLB API
- ⚡ **功能開關**：快速啟用或停用特定功能
- 🔑 **關鍵字自訂**：自定義系統指令關鍵字

---

## 如何使用

### 訪問設定頁面

1. **從首頁訪問**
   - 打開系統首頁
   - 點擊右上角的齒輪圖示 🔧

2. **直接訪問**
   - URL: `http://your-domain.com/settings`
   - 或在本地: `http://localhost:3000/settings`

### 修改設定

1. 在設定頁面中調整需要的參數
2. 點擊「💾 儲存所有設定」按鈕
3. 系統會自動備份舊設定並儲存新設定
4. 部分設定需要重新啟動系統才能生效

### 測試連線

- 點擊「🔌 測試連線」按鈕
- 系統會測試：
  - Bot 1 連線狀態
  - Bot 2 連線狀態（如已啟用）
  - Google Sheets API 連線

---

## 設定項目說明

### 🤖 LINE Bot 配置

#### Bot 1 (主要 Bot)
- **Channel Access Token**：LINE Bot 的存取令牌
- **Channel Secret**：LINE Bot 的密鑰
- **必須啟用**：主要 Bot 是系統運作的必要條件

#### Bot 2 (備用 Bot)
- **啟用 Bot 2**：勾選以啟用備用 Bot
- **Channel Access Token**：備用 Bot 的存取令牌
- **Channel Secret**：備用 Bot 的密鑰
- **用途**：分散 API 負載，節省費用

#### 管理員設定
- **管理員 LINE User ID**：接收系統通知的 LINE 用戶 ID

#### Rich Menu 設定
- **預設 Rich Menu ID**：一般用戶的選單 ID
- **內部人員 Rich Menu ID**：內部人員的選單 ID

---

## 雙 Bot 配置指南

### 為什麼需要雙 Bot？

LINE API 有以下限制：
- 免費方案有訊息發送數量限制
- 高峰時段可能遇到速率限制
- 單一 Bot 故障時系統會中斷

**解決方案**：使用雙 Bot 系統分散負載

### 設定步驟

#### 1. 建立第二個 LINE Bot

1. 前往 [LINE Developers Console](https://developers.line.biz/)
2. 建立新的 Provider 或使用現有的
3. 建立新的 Messaging API Channel
4. 取得 **Channel Access Token** 和 **Channel Secret**

#### 2. 在設定頁面配置

1. 找到「Bot 2 (備用 Bot)」區塊
2. 勾選「啟用 Bot 2」
3. 填入 Channel Access Token
4. 填入 Channel Secret
5. 儲存設定

#### 3. 配置負載平衡

在「💰 訊息發送策略」區塊中：

1. **啟用負載平衡**：勾選此選項
2. **選擇策略**：
   - **輪詢 (Round Robin)**：訊息平均分配到兩個 Bot
   - **隨機 (Random)**：隨機選擇 Bot 發送
   - **主要優先 (Primary First)**：優先使用主要 Bot，額外負載使用備用 Bot
3. **失敗回退**：建議保持勾選，當一個 Bot 失敗時自動使用另一個

---

## 節省 API 費用策略

### 💡 策略 1: 輪詢模式（最省錢）

**適用場景**：訊息量大，希望平均分配

**設定**：
- ✅ 啟用負載平衡
- 策略選擇：**輪詢 (Round Robin)**
- ✅ 失敗時回退到主要 Bot

**效果**：
- 訊息 50/50 分配
- 兩個 Bot 的免費額度都能充分利用
- **最多節省 50% 費用**

### 💡 策略 2: 主要優先模式（最安全）

**適用場景**：訊息量中等，希望穩定性優先

**設定**：
- ✅ 啟用負載平衡
- 策略選擇：**主要優先 (Primary First)**
- ✅ 失敗時回退到主要 Bot

**效果**：
- 主要 Bot 處理大部分訊息
- 備用 Bot 在高峰時分擔負載
- **節省約 20-30% 費用**

### 💡 策略 3: 隨機模式（平衡）

**適用場景**：訊息量不固定，希望自動調節

**設定**：
- ✅ 啟用負載平衡
- 策略選擇：**隨機 (Random)**
- ✅ 失敗時回退到主要 Bot

**效果**：
- 動態分配訊息
- 兩個 Bot 使用量接近
- **節省約 40-45% 費用**

### 🔧 其他優化設定

#### 批次發送延遲
- **建議值**：100-200 毫秒
- **作用**：避免觸發速率限制
- **過大**：發送速度慢
- **過小**：可能被限制

#### 最大重試次數
- **建議值**：3 次
- **作用**：發送失敗時重試
- **過大**：浪費時間
- **過小**：降低成功率

---

## 設定檔案說明

### 自動生成的 .env 文件

當您在 Web 界面儲存設定時，系統會自動：

1. ✅ 備份現有的 `.env` 文件（如果存在）
2. ✅ 生成新的 `.env` 文件
3. ✅ 標註最後更新時間

### 備份文件

備份文件格式：`.env.backup.YYYY-MM-DDTHH-MM-SS-sss`

例如：`.env.backup.2025-09-30T14-30-45-123`

### 手動編輯（不建議）

雖然您可以手動編輯 `.env` 文件，但**強烈建議**使用 Web 界面：

✅ **使用 Web 界面的優點**：
- 自動驗證
- 自動備份
- 格式正確
- 即時測試

❌ **手動編輯的風險**：
- 格式錯誤
- 沒有備份
- 無法驗證
- 可能導致系統故障

---

## 常見問題

### Q1: 修改設定後需要重新啟動系統嗎？

**A:** 大部分設定需要重新啟動才能生效，包括：
- LINE Bot Token/Secret
- API 端點
- 負載平衡策略

少數設定可以即時生效：
- UI 色彩（僅影響前端）
- 關鍵字（下次處理訊息時生效）

**建議**：每次修改設定後都重新啟動系統。

### Q2: 如何知道雙 Bot 是否正常工作？

**A:** 使用以下方法檢查：

1. **測試連線功能**
   - 在設定頁面點擊「測試連線」
   - 檢查 Bot 1 和 Bot 2 是否都顯示成功

2. **查看系統日誌**
   - 發送訊息時觀察日誌
   - 應該能看到不同 Bot 輪流發送

3. **LINE Developers Console**
   - 檢查兩個 Bot 的訊息統計
   - 確認訊息量分佈合理

### Q3: 如果備用 Bot 失敗了怎麼辦？

**A:** 如果啟用了「失敗時回退到主要 Bot」：
- 系統會自動偵測失敗
- 自動切換到主要 Bot 重試
- 記錄錯誤日誌

**建議**：定期檢查兩個 Bot 的狀態，確保都正常運作。

### Q4: 可以使用三個或更多 Bot 嗎？

**A:** 目前系統支援兩個 Bot（主要 + 備用）。

如需支援更多 Bot，需要修改程式碼。請參考 `config.js` 和 `server.js` 中的多 Bot 相關函數。

### Q5: 設定錯誤導致系統無法啟動怎麼辦？

**A:** 恢復方法：

1. **使用備份文件**
   ```bash
   # 找到最新的備份
   ls -lt .env.backup.*
   
   # 恢復備份
   cp .env.backup.YYYY-MM-DDTHH-MM-SS-sss .env
   ```

2. **手動建立最小配置**
   ```bash
   # 建立新的 .env 文件，只包含必要設定
   echo "LINE_CHANNEL_ACCESS_TOKEN=your_token" > .env
   echo "LINE_CHANNEL_SECRET=your_secret" >> .env
   echo "LINE_USER_ID=your_user_id" >> .env
   ```

3. **刪除 .env 使用預設值**
   ```bash
   rm .env
   # 系統會使用 config.js 中的預設值
   ```

### Q6: 如何匯出目前的設定？

**A:** 訪問以下 API：

```
GET http://your-domain.com/api/settings/export
```

會下載一個 JSON 格式的設定檔案。

### Q7: 負載平衡的「批次發送延遲」應該設多少？

**A:** 建議值：

- **訊息量小**（< 10/分鐘）：50-100 毫秒
- **訊息量中**（10-50/分鐘）：100-200 毫秒
- **訊息量大**（> 50/分鐘）：200-500 毫秒

**LINE API 限制**：
- 免費方案：500 訊息/月
- 輕量方案：5,000 訊息/月
- 標準方案：無限制（按量計費）

---

## 技術支援

如有任何問題，請：

1. 📖 查看系統日誌
2. 🔍 檢查設定備份
3. 🔧 使用測試連線功能
4. 📝 查看相關文檔：
   - `CONFIG_GUIDE.md` - 配置指南
   - `DUAL_BOT_SETUP.md` - 雙 Bot 設定指南
   - `API_DOCUMENTATION.md` - API 文檔

---

**最後更新**：2025-09-30  
**版本**：1.0.0

