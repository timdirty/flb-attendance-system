# 匯款金額修正功能

## 📋 功能概述

本功能解決匯款金額辨識錯誤的問題，並提供管理員手動修正機制。

## 🐛 問題描述

### 原問題
客戶傳送訊息：
```
訂金已匯，末五碼11204，戶名私立卓盟文理補習班...
```

系統誤將「末五碼11204」辨識為金額 NT$ 11,204。

### 根本原因
金額提取邏輯未排除銀行帳號相關的數字描述（如「末五碼」、「後五碼」等）。

## ✅ 解決方案

### 1️⃣ 金額提取邏輯優化

**檔案位置**：`server.js` - `parseAmountFromText()` 函數（第 3759 行）

**新增過濾規則**：
```javascript
// 格式四：排除「末五碼XXXXX」「後五碼XXXXX」「末X碼XXXXX」等帳號尾碼（支援中文數字）
.replace(/(?:末|後|尾|最後).{0,5}碼[\s]*\d{3,}/gi, ' ')

// 格式五：排除「帳號XXXXX」「帳號尾數XXXXX」
.replace(/帳號(?:尾數|後[\s]*\d+[\s]*碼)?[\s]*\d{3,}/gi, ' ')
```

**支援格式**：
- ✅ 末五碼11204
- ✅ 後五碼 99888
- ✅ 末3碼12345
- ✅ 帳號尾數67890
- ✅ 最後五碼11111

### 2️⃣ 金額修正流程

當金額辨識有誤時，管理員可以手動修正：

#### 步驟流程

1. **管理員收到匯款通知 Flex Message**
   - 包含兩個按鈕：
     - ✅ 已確認收款
     - ⚠️ 金額辨識有誤

2. **點擊「金額辨識有誤」**
   - 系統提示：「請直接回覆正確的金額（只需輸入數字）」
   - 顯示當前記錄資訊

3. **輸入正確金額**
   - 例如：`5000`
   - 系統自動：
     - 更新匯款記錄
     - 通知客戶（使用正確金額）
     - 記帳到 Notion（使用正確金額）

4. **完成確認**
   - 管理員收到確認訊息
   - 客戶收到付款確認 Flex Message（正確金額）

## 🔧 技術實作

### 狀態管理

**檔案**：`src/data/amount-correction-state.json`

**結構**：
```json
{
  "U1234567890abcdef": {
    "recordId": "remit_20251204_abc123",
    "timestamp": "2025-12-04T08:00:00.000Z"
  }
}
```

### API 端點

無需新增 API，使用現有 Webhook 機制。

### Postback 處理

**Action**: `remittance_correct_amount`

**資料結構**：
```json
{
  "action": "remittance_correct_amount",
  "recordId": "remit_20251204_abc123"
}
```

### 文字訊息處理

在文字訊息處理流程最前端檢查金額修正狀態（第 7366-7451 行）：
1. 檢查用戶是否處於「等待輸入金額」狀態
2. 驗證輸入是否為有效數字
3. 更新記錄並通知
4. 清除狀態

## 📊 測試結果

**測試檔案**：`validate-amount-extraction.js`

**測試案例**：20 個
**通過率**：100% ✅

**關鍵測試**：
- ✅ 末五碼11204 → 正確辨識為 null（不誤判為金額）
- ✅ 後五碼 99888 → 正確辨識為 null
- ✅ 帳號尾數12345 → 正確辨識為 null

## 💡 使用範例

### 範例 1：正常匯款確認

**客戶訊息**：
```
已匯款 NT$ 5000，請確認
```

**系統行為**：
- 辨識金額：5000 ✅
- 通知管理員
- 管理員點擊「✅ 已確認收款」
- 客戶收到確認訊息

### 範例 2：金額辨識錯誤

**客戶訊息**：
```
訂金已匯，末五碼11204
```

**系統行為**：
- 辨識金額：null（無法辨識）⚠️
- 通知管理員（顯示「金額待確認」）
- 管理員點擊「⚠️ 金額辨識有誤」
- 輸入正確金額：`5000`
- 系統更新並通知客戶：NT$ 5,000 ✅

## 🔄 整合功能

### Notion 記帳整合

使用修正後的金額進行 Notion 記帳：
- 更新記錄時包含 `amountCorrectedBy` 和 `amountCorrectedAt`
- 記帳金額使用最終確認的金額

### 客戶通知

客戶收到的 Flex Message 顯示正確金額：
- 標題：「付款已確認」
- 金額：NT$ {正確金額}
- 確認時間：自動記錄

## 📝 注意事項

1. **數字格式**：管理員輸入金額時只需輸入純數字（如 `5000`），系統會自動處理格式化
2. **狀態清理**：每次金額修正完成後自動清除狀態，避免重複處理
3. **驗證機制**：輸入無效數字時會提示重新輸入
4. **記錄保留**：原始辨識金額和修正金額都會保留在記錄中

## 🚀 後續優化建議

1. **自動學習**：收集修正記錄，優化 OCR 辨識規則
2. **金額建議**：根據客戶歷史訂單，提供可能的金額選項
3. **批次處理**：支援同時修正多筆匯款記錄
4. **提醒機制**：超過一定時間未確認的匯款自動提醒

## 📅 更新記錄

- **2025-12-04**：新增金額修正功能，優化金額提取邏輯（排除末五碼等銀行帳號資訊）
