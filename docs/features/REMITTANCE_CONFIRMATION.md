# 💰 匯款確認功能說明

## 📖 功能概述

當客戶發送匯款相關的訊息或截圖時，系統會自動：
1. 偵測匯款訊息
2. 發送 Flex Message 通知到管理員群組
3. 管理員點擊確認按鈕後，自動回覆客戶

---

## 🔧 設定步驟

### 1. 設定環境變數

在 `.env` 檔案中加入以下設定：

```bash
# 匯款通知設定
REMITTANCE_GROUP_ID=your_remittance_group_id_here  # 選填：接收通知的群組 ID
REMITTANCE_CONFIRM_ACTION=remittance_confirm       # 選填：預設值即可
REMITTANCE_KEYWORDS=匯款,轉帳,轉帳完成,已轉,ATM      # 選填：可自訂關鍵字
REMITTANCE_THEME_COLOR=#00C300                     # 選填：Flex Message 主題色

# 管理員設定（至少需要設定其中一項）
LINE_USER_ID=Udb51363eb6fdc605a6a9816379a38103     # 單一管理員
# 或使用多管理員模式
ADMIN_USER_IDS=Udb51363eb6fdc605a6a9816379a38103,U1234567890abcdef
```

### 2. 設定管理員

**方式一：使用設定檔**（推薦）

編輯 `src/data/admin-users.json`：
```json
[
  {
    "userId": "Udb51363eb6fdc605a6a9816379a38103",
    "name": "主要管理員",
    "enabled": true
  }
]
```

**方式二：使用環境變數**
```bash
ADMIN_USER_IDS=Udb51363eb6fdc605a6a9816379a38103
```

**方式三：使用群組**（選填）
```bash
REMITTANCE_GROUP_ID=your_group_id  # 取得方式見下方說明
```

### 3. 取得群組 ID（如使用群組通知）

將 LINE Bot 加入目標群組後，發送任意訊息，查看伺服器日誌即可找到群組 ID。

**💡 提示**：
- 可以同時設定管理員和群組，系統會同時發送到兩處
- 至少需要設定其中一項（管理員或群組）
- 多管理員模式請參考 [多管理員使用指南](./MULTI_ADMIN_GUIDE.md)

---

## 🎯 觸發條件

### 文字訊息觸發

當訊息包含以下任一關鍵字時觸發：
- `匯款`
- `轉帳`
- `轉帳完成`
- `已轉`
- `ATM`

**範例**：
```
✅ "我已經轉帳 1500 元了"
✅ "匯款完成"
✅ "ATM 轉帳 NT$2000"
❌ "請問如何付款？" （不包含關鍵字）
```

### 圖片訊息觸發

當訊息**同時包含**：
1. 匯款關鍵字
2. 圖片附件（通常是匯款截圖）

**範例**：
```
✅ 文字："已匯款" + 截圖
✅ 文字："轉帳完成" + 截圖
❌ 只有截圖沒有文字
```

---

## 💬 Flex Message 內容

### 發送給管理員的通知

```
┌─────────────────────────┐
│   匯款待確認             │
│   NT$ 1,500             │  ← 自動解析金額
├─────────────────────────┤
│ 來自   王小明            │
│ 訊息   我已經轉帳 1500... │
│ 時間   2024/11/21 13:41  │
├─────────────────────────┤
│   [ ✅ 已確認收款 ]       │  ← 點擊按鈕確認
│   [ 查看原始訊息 ]        │
└─────────────────────────┘
```

### 自動解析金額

系統會嘗試從文字中解析金額，支援以下格式：
- `1500`
- `NT$1500`
- `NT$ 1,500`
- `台幣 1500 元`
- `1500 塊`

---

## 🔄 確認流程

### 1. 客戶發送匯款訊息

```
客戶：「我已經轉帳 1500 元了」
```

### 2. 系統自動處理

✅ 偵測到匯款關鍵字  
✅ 解析金額：NT$1,500  
✅ 建立記錄 (ID: remit_xxx)  
✅ 發送 Flex Message 到管理員群組  
✅ 回覆客戶：「📄 已收到您的匯款資訊，將盡快為您確認。」

### 3. 管理員確認

管理員在群組中點擊 **「✅ 已確認收款」** 按鈕

### 4. 系統回覆

✅ 更新記錄狀態為 `confirmed`  
✅ 記錄確認人和確認時間  
✅ 回覆管理員：「✅ 已回覆客戶，金額 NT$1,500」  
✅ **自動推播給客戶：「✅ 已確認收到您的匯款：NT$1,500\n感謝！」**

---

## 📊 資料儲存

### 記錄檔案位置

```
src/data/remittance-records.json
```

### 記錄格式

```json
[
  {
    "id": "remit_1732171260123_abc123",
    "userId": "U1234567890abcdef",
    "displayName": "王小明",
    "sourceType": "user",
    "groupId": null,
    "messageText": "我已經轉帳 1500 元了",
    "messageId": "12345678901234",
    "amount": "1500",
    "createdAt": "2024-11-21T05:41:00.123Z",
    "status": "confirmed",
    "confirmedBy": "U0987654321fedcba",
    "confirmedAt": "2024-11-21T05:42:15.456Z"
  }
]
```

---

## 🧪 測試步驟

### 1. 測試文字觸發

```bash
# 在 LINE 中發送
"我已經轉帳 1500 元了"

# 預期結果
✅ Bot 回覆：「📄 已收到您的匯款資訊，將盡快為您確認。」
✅ 管理員群組收到 Flex Message
```

### 2. 測試圖片觸發

```bash
# 在 LINE 中發送（文字 + 圖片）
文字：「匯款完成」
圖片：[匯款截圖]

# 預期結果
✅ Bot 回覆：「📄 已收到您的匯款資訊，將盡快為您確認。」
✅ 管理員群組收到 Flex Message
```

### 3. 測試確認流程

```bash
# 管理員在群組中點擊「✅ 已確認收款」按鈕

# 預期結果
✅ 管理員收到：「✅ 已回覆客戶，金額 NT$1,500」
✅ 客戶自動收到：「✅ 已確認收到您的匯款：NT$1,500\n感謝！」
```

---

## 🔍 除錯與監控

### 查看日誌

```bash
# 本機開發
npm run dev

# Docker 容器
docker logs flb-attendance-system -f
```

### 關鍵日誌訊息

```
✅ 成功發送匯款通知到群組
❌ REMITTANCE_GROUP_ID 未設定，跳過匯款提醒
❌ 回覆客戶匯款確認失敗
```

### 檢查記錄檔案

```bash
cat src/data/remittance-records.json
```

---

## ⚠️ 注意事項

1. **必須設定 `REMITTANCE_GROUP_ID`**  
   若未設定，功能將不會啟用

2. **關鍵字大小寫不敏感**  
   `匯款` = `匯款` = `huikuan`（全形/半形通用）

3. **金額解析僅供參考**  
   系統會盡量解析，但管理員仍需核對實際金額

4. **記錄檔案不會自動清理**  
   建議定期備份或清理舊記錄

5. **按鈕只能點擊一次**  
   確認後的記錄會更新狀態，重複點擊會提示「找不到對應的匯款紀錄」

---

## 🎨 自訂設定

### 修改主題色

```bash
# .env
REMITTANCE_THEME_COLOR=#FF6B6B  # 改為紅色
```

### 新增關鍵字

```bash
# .env
REMITTANCE_KEYWORDS=匯款,轉帳,轉帳完成,已轉,ATM,付款完成,已付款
```

### 修改確認訊息

編輯 `server.js` 第 993 行：

```javascript
await sendLineMessageWithBot(
  `✅ 已確認收到您的匯款${updated.amount ? `：NT$${updated.amount}` : ''}\n感謝您的支持！`,  // 自訂訊息
  record.userId,
  null,
  false
);
```

---

## 📚 相關檔案

- **主程式**：`server.js` (第 150-176, 950-998, 3641-3810 行)
- **配置**：`src/config.js` (第 230-242 行)
- **記錄**：`src/data/remittance-records.json`
- **環境變數範例**：`env.example` (第 25-33 行)

---

## 🚀 未來擴充建議

- [ ] 支援多個管理員群組
- [ ] 新增「拒絕」按鈕
- [ ] 整合 Google Sheets 記錄匯款
- [ ] 支援更多支付方式（信用卡、LINE Pay 等）
- [ ] 自動對帳功能
- [ ] 匯款記錄查詢介面

---

**建立日期**：2024/11/21  
**最後更新**：2024/11/21  
**維護者**：FLB 簽到系統團隊
