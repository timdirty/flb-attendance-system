# ğŸ¥ è½‰ç™¼ç³»çµ± - å­¸ç”Ÿè«‹å‡åŠŸèƒ½å¯¦ç¾æŒ‡å—

## ğŸ’¡ æ–¹æ¡ˆèªªæ˜

**ç›´æ¥åœ¨è½‰ç™¼ç³»çµ±ä¸Šå¯¦ç¾è«‹å‡åŠŸèƒ½ï¼Œç„¡éœ€è½‰ç™¼ postback äº‹ä»¶**

### å„ªé»
- âœ… æ¶æ§‹æ›´ç°¡å–®ï¼ˆä¸éœ€è¦è½‰ç™¼ postbackï¼‰
- âœ… æ¸›å°‘ç¶²è·¯å¾€è¿”
- âœ… è½‰ç™¼ç³»çµ±ç›´æ¥æ§åˆ¶äº’å‹•é‚è¼¯
- âœ… æ›´å®¹æ˜“èª¿è©¦

### æ•¸æ“šæµ
```
1. LINE â†’ è½‰ç™¼ç³»çµ±ï¼ˆpostback: è«‹å‡ï¼‰
2. è½‰ç™¼ç³»çµ± â†’ LINEï¼ˆè©¢å•ç†ç”±ï¼‰
3. LINE â†’ è½‰ç™¼ç³»çµ±ï¼ˆpostback: ç†ç”±ï¼‰
4. è½‰ç™¼ç³»çµ± â†’ FLB APIï¼ˆè¨˜éŒ„æ•¸æ“šï¼‰
5. è½‰ç™¼ç³»çµ± â†’ LINEï¼ˆç¢ºèªè¨Šæ¯ï¼‰
```

---

## ğŸ“‹ å¯¦ç¾æ­¥é©Ÿ

### Step 1: åœ¨è½‰ç™¼ç³»çµ±æ·»åŠ  postback è™•ç†

åœ¨æ‚¨çš„è½‰ç™¼ç³»çµ±ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç¢¼ï¼ˆNode.js ç¯„ä¾‹ï¼‰ï¼š

```javascript
// ========================================
// å­¸ç”Ÿè«‹å‡åŠŸèƒ½è™•ç†
// ========================================

const axios = require('axios');
const FLB_API_BASE = 'https://calendar.funlearnbar.synology.me';

// æš«å­˜ç­‰å¾…ç†ç”±çš„è«‹å‡ç”³è«‹
const pendingLeaves = new Map();

// Webhook è™•ç†å™¨
app.post('/webhook', async (req, res) => {
  const events = req.body.events;
  
  for (const event of events) {
    // ====================================
    // è™•ç† postback äº‹ä»¶ï¼ˆè«‹å‡åŠŸèƒ½ï¼‰
    // ====================================
    if (event.type === 'postback') {
      await handlePostback(event);
      
      // âš ï¸ ä¸è½‰ç™¼ postback åˆ° FLB ç³»çµ±
      // ç›´æ¥åœ¨é€™è£¡è™•ç†å®Œæˆ
      continue;
    }
    
    // ====================================
    // å…¶ä»–äº‹ä»¶é¡å‹ï¼ˆmessage ç­‰ï¼‰ä»ç„¶è½‰ç™¼
    // ====================================
    if (event.type === 'message') {
      await forwardToFLB(req.body);
    }
  }
  
  res.json({ success: true });
});

// ========================================
// Postback è™•ç†å‡½æ•¸
// ========================================
async function handlePostback(event) {
  const postbackData = parsePostbackData(event.postback.data);
  const userId = event.source.userId;
  
  // ------------------------------------
  // 1ï¸âƒ£ å­¸ç”Ÿé»æ“Šã€ŒğŸ¥ è«‹å‡ã€
  // ------------------------------------
  if (postbackData.action === 'attendance_reply' && postbackData.response === 'leave') {
    console.log('ğŸ¥ æ”¶åˆ°è«‹å‡ç”³è«‹:', postbackData.studentName);
    
    // æš«å­˜è«‹å‡ç”³è«‹
    const leaveKey = `${userId}_${postbackData.courseDate}`;
    pendingLeaves.set(leaveKey, {
      userId,
      studentName: postbackData.studentName,
      courseName: postbackData.courseName,
      courseDate: postbackData.courseDate,
      courseTime: postbackData.courseTime,
      location: postbackData.location,
      weekday: postbackData.weekday,
      timestamp: new Date().toISOString()
    });
    
    // ç™¼é€è«‹å‡ç†ç”±é¸é …
    await sendLeaveReasonOptions(userId, postbackData);
    
    // æ¸…ç†éæœŸçš„æš«å­˜ï¼ˆ1å°æ™‚å¾Œï¼‰
    setTimeout(() => pendingLeaves.delete(leaveKey), 3600000);
  }
  
  // ------------------------------------
  // 2ï¸âƒ£ å­¸ç”Ÿé¸æ“‡è«‹å‡ç†ç”±
  // ------------------------------------
  else if (postbackData.action === 'leave_reason') {
    console.log('ğŸ“ æ”¶åˆ°è«‹å‡ç†ç”±:', postbackData.reason);
    
    const leaveKey = `${userId}_${postbackData.courseDate}`;
    const leaveInfo = pendingLeaves.get(leaveKey);
    
    if (leaveInfo) {
      // è¨˜éŒ„åˆ° FLB ç³»çµ±
      await saveLeaveToFLB({
        ...leaveInfo,
        leaveReason: postbackData.reason
      });
      
      // ç™¼é€ç¢ºèªè¨Šæ¯çµ¦å­¸ç”Ÿ
      await sendLeaveConfirmation(userId, leaveInfo, postbackData.reason);
      
      // é€šçŸ¥ç®¡ç†å“¡
      await notifyAdminAboutLeave(leaveInfo, postbackData.reason);
      
      // æ¸…ç†æš«å­˜
      pendingLeaves.delete(leaveKey);
    } else {
      // æ‰¾ä¸åˆ°å°æ‡‰çš„è«‹å‡ç”³è«‹
      await lineClient.replyMessage(event.replyToken, {
        type: 'text',
        text: 'æŠ±æ­‰ï¼Œæ‰¾ä¸åˆ°å°æ‡‰çš„è«‹å‡ç”³è«‹ï¼Œè«‹é‡æ–°æ“ä½œã€‚'
      });
    }
  }
  
  // ------------------------------------
  // 3ï¸âƒ£ å…¶ä»–å‡ºå¸­å›æ‡‰ï¼ˆæœƒå‡ºå¸­ã€å¾…ç¢ºèªï¼‰
  // ------------------------------------
  else if (postbackData.action === 'attendance_reply') {
    // ç›´æ¥è¨˜éŒ„åˆ° FLB ç³»çµ±
    await saveResponseToFLB({
      userId,
      studentName: postbackData.studentName,
      courseName: postbackData.courseName,
      courseDate: postbackData.courseDate,
      responseType: postbackData.response, // 'attend' or 'pending'
      timestamp: new Date().toISOString()
    });
    
    // ç™¼é€ç¢ºèªè¨Šæ¯
    const responseText = postbackData.response === 'attend' ? 'æœƒå‡ºå¸­' : 'å¾…ç¢ºèª';
    await lineClient.replyMessage(event.replyToken, {
      type: 'text',
      text: `âœ… å·²è¨˜éŒ„æ‚¨çš„å›è¦†ï¼š${responseText}\n\nèª²ç¨‹ï¼š${postbackData.courseName}\næ—¥æœŸï¼š${postbackData.courseDate}`
    });
  }
}

// ========================================
// è¼”åŠ©å‡½æ•¸
// ========================================

// è§£æ postback data
function parsePostbackData(dataString) {
  try {
    return JSON.parse(dataString);
  } catch (e) {
    console.error('âŒ ç„¡æ³•è§£æ postback data:', dataString);
    return {};
  }
}

// ç™¼é€è«‹å‡ç†ç”±é¸é …
async function sendLeaveReasonOptions(userId, postbackData) {
  const message = {
    type: 'text',
    text: `ğŸ¥ ${postbackData.studentName} - ${postbackData.courseName}\n${postbackData.courseDate}\n\nè«‹é¸æ“‡è«‹å‡ç†ç”±ï¼š`,
    quickReply: {
      items: [
        {
          type: 'action',
          action: {
            type: 'postback',
            label: 'ğŸ¤’ ç”Ÿç—…',
            data: JSON.stringify({
              action: 'leave_reason',
              reason: 'ç”Ÿç—…',
              studentName: postbackData.studentName,
              courseName: postbackData.courseName,
              courseDate: postbackData.courseDate
            }),
            displayText: 'ğŸ¤’ ç”Ÿç—…'
          }
        },
        {
          type: 'action',
          action: {
            type: 'postback',
            label: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶åº­å› ç´ ',
            data: JSON.stringify({
              action: 'leave_reason',
              reason: 'å®¶åº­å› ç´ ',
              studentName: postbackData.studentName,
              courseName: postbackData.courseName,
              courseDate: postbackData.courseDate
            }),
            displayText: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶åº­å› ç´ '
          }
        },
        {
          type: 'action',
          action: {
            type: 'postback',
            label: 'âš ï¸ è‡¨æ™‚æœ‰äº‹',
            data: JSON.stringify({
              action: 'leave_reason',
              reason: 'è‡¨æ™‚æœ‰äº‹',
              studentName: postbackData.studentName,
              courseName: postbackData.courseName,
              courseDate: postbackData.courseDate
            }),
            displayText: 'âš ï¸ è‡¨æ™‚æœ‰äº‹'
          }
        },
        {
          type: 'action',
          action: {
            type: 'postback',
            label: 'ğŸ“ å…¶ä»–',
            data: JSON.stringify({
              action: 'leave_reason',
              reason: 'å…¶ä»–',
              studentName: postbackData.studentName,
              courseName: postbackData.courseName,
              courseDate: postbackData.courseDate
            }),
            displayText: 'ğŸ“ å…¶ä»–'
          }
        }
      ]
    }
  };
  
  await lineClient.pushMessage(userId, message);
  console.log('âœ… å·²ç™¼é€è«‹å‡ç†ç”±é¸é …');
}

// å„²å­˜è«‹å‡è¨˜éŒ„åˆ° FLB ç³»çµ±
async function saveLeaveToFLB(leaveData) {
  try {
    const response = await axios.post(
      `${FLB_API_BASE}/api/student-responses`,
      {
        studentName: leaveData.studentName,
        courseName: leaveData.courseName,
        courseDate: leaveData.courseDate,
        responseType: 'leave',
        leaveReason: leaveData.leaveReason,
        userId: leaveData.userId,
        timestamp: leaveData.timestamp
      },
      {
        headers: {
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('âœ… è«‹å‡è¨˜éŒ„å·²å„²å­˜åˆ° FLB ç³»çµ±');
    return response.data;
  } catch (error) {
    console.error('âŒ å„²å­˜è«‹å‡è¨˜éŒ„å¤±æ•—:', error.message);
    throw error;
  }
}

// å„²å­˜ä¸€èˆ¬å‡ºå¸­å›æ‡‰åˆ° FLB ç³»çµ±
async function saveResponseToFLB(responseData) {
  try {
    const response = await axios.post(
      `${FLB_API_BASE}/api/student-responses`,
      responseData,
      {
        headers: {
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log('âœ… å­¸ç”Ÿå›æ‡‰å·²å„²å­˜åˆ° FLB ç³»çµ±');
    return response.data;
  } catch (error) {
    console.error('âŒ å„²å­˜å­¸ç”Ÿå›æ‡‰å¤±æ•—:', error.message);
    throw error;
  }
}

// ç™¼é€ç¢ºèªè¨Šæ¯çµ¦å­¸ç”Ÿ
async function sendLeaveConfirmation(userId, leaveInfo, reason) {
  const message = {
    type: 'text',
    text: `âœ… å·²è¨˜éŒ„æ‚¨çš„è«‹å‡ç”³è«‹\n\nğŸ‘¤ å­¸ç”Ÿï¼š${leaveInfo.studentName}\nğŸ“– èª²ç¨‹ï¼š${leaveInfo.courseName}\nğŸ“… æ—¥æœŸï¼š${leaveInfo.courseDate}\nğŸ¥ ç‹€æ…‹ï¼šè«‹å‡\nğŸ“ ç†ç”±ï¼š${reason}\n\næˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è«‹å‡é€šçŸ¥ï¼Œæ„Ÿè¬é…åˆï¼`
  };
  
  await lineClient.pushMessage(userId, message);
  console.log('âœ… å·²ç™¼é€ç¢ºèªè¨Šæ¯çµ¦å­¸ç”Ÿ');
}

// é€šçŸ¥ç®¡ç†å“¡
async function notifyAdminAboutLeave(leaveInfo, reason) {
  const ADMIN_GROUP_ID = process.env.ADMIN_GROUP_ID; // å¾ç’°å¢ƒè®Šæ•¸è®€å–
  
  if (!ADMIN_GROUP_ID) {
    console.warn('âš ï¸ æœªè¨­å®šç®¡ç†å“¡ç¾¤çµ„ IDï¼Œè·³éé€šçŸ¥');
    return;
  }
  
  const message = {
    type: 'text',
    text: `ğŸ¥ å­¸ç”Ÿè«‹å‡é€šçŸ¥\n\nğŸ‘¤ å­¸ç”Ÿï¼š${leaveInfo.studentName}\nğŸ“– èª²ç¨‹ï¼š${leaveInfo.courseName}\nğŸ“… æ—¥æœŸï¼š${leaveInfo.courseDate} ${leaveInfo.weekday}\nâ° æ™‚é–“ï¼š${leaveInfo.courseTime}\nğŸ“ åœ°é»ï¼š${leaveInfo.location}\nğŸ¥ ç†ç”±ï¼š${reason}\nâ±ï¸ å›è¦†æ™‚é–“ï¼š${new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })}`
  };
  
  await lineClient.pushMessage(ADMIN_GROUP_ID, message);
  console.log('âœ… å·²é€šçŸ¥ç®¡ç†å“¡');
}
```

---

## ğŸ”§ ç’°å¢ƒè®Šæ•¸è¨­å®š

åœ¨è½‰ç™¼ç³»çµ±çš„ `.env` æª”æ¡ˆä¸­æ·»åŠ ï¼š

```env
# LINE Bot è¨­å®š
LINE_CHANNEL_ACCESS_TOKEN=ä½ çš„_LINE_Channel_Access_Token

# ç®¡ç†å“¡é€šçŸ¥è¨­å®š
ADMIN_GROUP_ID=ä½ çš„ç®¡ç†å“¡ç¾¤çµ„ID

# FLB API
FLB_API_BASE=https://calendar.funlearnbar.synology.me
```

---

## ğŸ“Š FLB ç³»çµ±éœ€è¦çš„ API

FLB ç³»çµ±éœ€è¦æä¾›ä»¥ä¸‹ API ç«¯é»ä¾†æ¥æ”¶å­¸ç”Ÿå›æ‡‰ï¼š

### POST `/api/student-responses`

**è«‹æ±‚ç¯„ä¾‹**ï¼š
```json
{
  "studentName": "ç‹å°æ˜",
  "courseName": "ESM å›› 16:00-17:00",
  "courseDate": "2025-10-23",
  "responseType": "leave",
  "leaveReason": "ç”Ÿç—…",
  "userId": "U1234567890abcdef",
  "timestamp": "2025-10-23T08:00:00.000Z"
}
```

**å›æ‡‰ç¯„ä¾‹**ï¼š
```json
{
  "success": true,
  "message": "å­¸ç”Ÿå›æ‡‰å·²è¨˜éŒ„",
  "data": {
    "id": "response_1729650000000_abc123"
  }
}
```

---

## ğŸ§ª æ¸¬è©¦æ–¹æ³•

### 1. æ¸¬è©¦è«‹å‡æµç¨‹

```bash
# åœ¨è½‰ç™¼ç³»çµ±ä¸Š
npm test -- --grep "å­¸ç”Ÿè«‹å‡"
```

### 2. æ‰‹å‹•æ¸¬è©¦

1. ç™¼é€èª²ç¨‹æé†’çµ¦å­¸ç”Ÿï¼ˆå« ğŸ¥ è«‹å‡æŒ‰éˆ•ï¼‰
2. å­¸ç”Ÿé»æ“Šã€ŒğŸ¥ è«‹å‡ã€
3. æª¢æŸ¥è½‰ç™¼ç³»çµ±æ—¥èªŒï¼š
   ```bash
   docker logs -f flb-line-bot | grep "ğŸ¥"
   ```
4. ç¢ºèªæ”¶åˆ°ç†ç”±é¸é …
5. é¸æ“‡ç†ç”±
6. ç¢ºèªæ”¶åˆ°ç¢ºèªè¨Šæ¯

### 3. é©—è­‰æ•¸æ“š

```bash
# æŸ¥è©¢ FLB ç³»çµ±
curl https://calendar.funlearnbar.synology.me/api/student-responses
```

---

## âœ… å„ªå‹¢ç¸½çµ

### èˆŠæ–¹æ¡ˆï¼ˆè½‰ç™¼ postbackï¼‰
```
LINE â†’ è½‰ç™¼ç³»çµ± â†’ FLB ç³»çµ±ï¼ˆè™•ç† postbackï¼‰
      â†“
    éœ€è¦é…ç½®è½‰ç™¼è¦å‰‡
    éœ€è¦è™•ç† header
    å¤šä¸€æ¬¡ç¶²è·¯å¾€è¿”
```

### æ–°æ–¹æ¡ˆï¼ˆç›´æ¥è™•ç†ï¼‰
```
LINE â†’ è½‰ç™¼ç³»çµ±ï¼ˆç›´æ¥è™•ç† postbackï¼‰
       â†“
     åªç™¼é€çµæœæ•¸æ“šçµ¦ FLB API
     æ¶æ§‹ç°¡å–®
     å®¹æ˜“ç¶­è­·
```

---

## ğŸ“ å¾ŒçºŒå·¥ä½œ

1. âœ… åœ¨è½‰ç™¼ç³»çµ±æ·»åŠ ä¸Šè¿°ä»£ç¢¼
2. âœ… è¨­å®šç’°å¢ƒè®Šæ•¸
3. âœ… æ¸¬è©¦è«‹å‡æµç¨‹
4. âœ… ç¢ºèªæ•¸æ“šæ­£ç¢ºå„²å­˜åˆ° FLB ç³»çµ±

---

## ğŸ†˜ éœ€è¦å”åŠ©ï¼Ÿ

å¦‚æœåœ¨å¯¦ç¾éç¨‹ä¸­é‡åˆ°å•é¡Œï¼Œè«‹æä¾›ï¼š
- è½‰ç™¼ç³»çµ±çš„æ—¥èªŒ
- éŒ¯èª¤è¨Šæ¯
- æ¸¬è©¦æ­¥é©Ÿ

---

*æ–‡æª”ç‰ˆæœ¬: 1.0*  
*å»ºç«‹æ™‚é–“: 2025-10-23*  
*é©ç”¨æ–¼: Node.js è½‰ç™¼ç³»çµ±*

