# 📸 OCR 圖片辨識功能測試案例

> **測試範圍**：Google Vision API 圖片文字辨識與匯款關鍵字偵測  
> **測試日期**：2025-11-21  
> **前置條件**：需設定 Google Vision API Key

---

## 📋 測試準備

### 前置條件

1. ✅ 伺服器已啟動
2. ✅ LINE Bot 已設定完成
3. ✅ 管理員 User ID 已設定
4. ✅ **Google Vision API Key 已設定** ⭐
5. ✅ OCR Provider 已設為 `google_vision`

### 環境檢查

```bash
# 檢查 OCR 設定
grep "OCR_PROVIDER" .env
grep "GOOGLE_VISION_API_KEY" .env

# 確認 OCR 已啟用
# 應顯示: OCR_PROVIDER=google_vision
# 應顯示: GOOGLE_VISION_API_KEY=your_api_key_here
```

### 必要配置

```bash
# .env 檔案
OCR_PROVIDER=google_vision
GOOGLE_VISION_API_KEY=your_google_cloud_vision_api_key
GOOGLE_VISION_ENDPOINT=https://vision.googleapis.com/v1/images:annotate  # 選填
```

---

## 🎯 測試案例總覽

| 測試組 | 案例數 | 說明 |
|--------|--------|------|
| I. OCR 基本功能 | 5 | Google Vision API 辨識能力 |
| J. OCR + 匯款關鍵字 | 6 | 圖片辨識 + 關鍵字偵測 |
| K. OCR + 語意過濾 | 4 | 圖片辨識 + 語意判斷 |
| L. 混合訊息 | 3 | 文字 + 圖片組合 |
| M. OCR 錯誤處理 | 4 | 異常情況處理 |
| **總計** | **22** | **完整 OCR 功能覆蓋** |

---

## 🧪 測試案例

### 測試組 I：OCR 基本功能（5 個案例）

#### I1. 純文字圖片（清晰）
**測試內容**：上傳包含清晰文字「我已經匯款 1500 元」的圖片

**預期結果**：
- ✅ OCR 成功辨識：「我已經匯款 1500 元」
- ✅ 日誌顯示：「📝 OCR 辨識文字（截斷顯示）: 我已經匯款 1500 元」
- ✅ 觸發匯款通知（包含關鍵字「匯款」）
- ✅ 金額正確解析為 `1500`

**實際結果**：


**測試圖片準備**：使用手機截圖或文字編輯器截圖

---

#### I2. 匯款截圖（ATM 轉帳）
**測試內容**：上傳 ATM 轉帳成功截圖

**預期OCR 辨識內容**：
- 應包含：「轉帳」或「ATM」或「匯款」
- 可能包含：金額、日期、帳號等資訊

**預期結果**：
- ✅ OCR 辨識出關鍵字
- ✅ 觸發匯款通知
- ✅ 金額解析（如圖片中有清晰金額）

**實際結果**：


---

#### I3. 匯款截圖（網路銀行）
**測試內容**：上傳網路銀行轉帳成功截圖

**預期 OCR 辨識內容**：
- 應包含：「轉帳完成」或「匯款成功」
- 可能包含：金額、收款戶名等

**預期結果**：
- ✅ OCR 辨識出關鍵字
- ✅ 觸發匯款通知

**實際結果**：


---

#### I4. 手寫文字圖片
**測試內容**：上傳手寫「已轉帳 2000 元」的圖片

**預期結果**：
- ⚠️ OCR 可能辨識不完整（視手寫清晰度）
- ✅ 如辨識出關鍵字，應觸發通知
- ⚠️ 如辨識失敗，不觸發通知（正常行為）

**實際結果**：


---

#### I5. 模糊圖片
**測試內容**：上傳模糊的匯款截圖

**預期結果**：
- ⚠️ OCR 可能辨識失敗
- ✅ 系統應正常處理，不觸發通知
- ✅ 日誌顯示：「⚠️ OCR 未偵測到文字，暫不處理匯款通知」

**實際結果**：


---

### 測試組 J：OCR + 匯款關鍵字（6 個案例）

#### J1. 圖片包含「匯款」
**測試內容**：上傳包含「匯款」文字的圖片（無其他文字）

**預期結果**：
- ✅ OCR 辨識：「匯款」
- ✅ 關鍵字匹配成功
- ✅ 觸發匯款通知

**實際結果**：


---

#### J2. 圖片包含「轉帳」
**測試內容**：上傳包含「轉帳」文字的圖片

**預期結果**：
- ✅ OCR 辨識：「轉帳」
- ✅ 關鍵字匹配成功
- ✅ 觸發匯款通知

**實際結果**：


---

#### J3. 圖片包含「ATM」
**測試內容**：上傳包含「ATM」文字的圖片

**預期結果**：
- ✅ OCR 辨識：「ATM」
- ✅ 關鍵字匹配成功
- ✅ 觸發匯款通知

**實際結果**：


---

#### J4. 圖片包含多個關鍵字
**測試內容**：上傳包含「ATM 轉帳 匯款完成」的圖片

**預期結果**：
- ✅ OCR 辨識多個關鍵字
- ✅ 觸發匯款通知
- ✅ 只通知一次（非重複）

**實際結果**：


---

#### J5. 圖片包含金額
**測試內容**：上傳包含「轉帳 NT$3,500」的圖片

**預期結果**：
- ✅ OCR 辨識：「轉帳 NT$3,500」
- ✅ 關鍵字匹配：「轉帳」
- ✅ 金額解析：`3500`
- ✅ 管理員看到金額 `NT$ 3,500`

**實際結果**：


---

#### J6. 圖片無匯款關鍵字
**測試內容**：上傳一般文字圖片（如「今天天氣很好」）

**預期結果**：
- ✅ OCR 辨識成功
- ❌ 無匯款關鍵字，不觸發通知
- ✅ 日誌顯示：「⚠️ 收到圖片但未偵測到匯款關鍵字」

**實際結果**：


---

### 測試組 K：OCR + 語意過濾（4 個案例）

#### K1. 圖片包含延後關鍵字
**測試內容**：上傳包含「明天會匯款」的圖片

**預期結果**：
- ✅ OCR 辨識：「明天會匯款」
- ✅ 關鍵字匹配：「匯款」
- ✅ 語意過濾：偵測到「明天」
- ✅ Bot 回覆延後訊息，**不觸發**管理員通知
- ✅ 記錄寫入 `remittance-intent-log.json`

**實際結果**：


---

#### K2. 圖片包含否定關鍵字
**測試內容**：上傳包含「還沒匯款」的圖片

**預期結果**：
- ✅ OCR 辨識：「還沒匯款」
- ✅ 語意過濾：偵測到「還沒」
- ✅ Bot 回覆延後訊息，不觸發通知

**實際結果**：


---

#### K3. 圖片包含詢問
**測試內容**：上傳包含「請問如何匯款？」的圖片

**預期結果**：
- ✅ OCR 辨識含疑問句
- ✅ 語意過濾：偵測到「請問」或「？」
- ✅ Bot 回覆延後訊息，不觸發通知

**實際結果**：


---

#### K4. 圖片包含疑問標記
**測試內容**：上傳包含「匯款了嗎？」的圖片

**預期結果**：
- ✅ OCR 辨識：「匯款了嗎？」
- ✅ 語意過濾：偵測到「？」
- ✅ Bot 回覆延後訊息，不觸發通知

**實際結果**：


---

### 測試組 L：混合訊息（3 個案例）

#### L1. 文字 + 圖片（都有關鍵字）
**測試內容**：
1. 發送文字：「我已經匯款了」
2. 立即發送圖片：包含「轉帳完成」

**預期結果**：
- ✅ 第一則訊息觸發通知（文字）
- ✅ 第二則訊息觸發通知（圖片 OCR）
- ✅ 兩筆獨立記錄

**實際結果**：


---

#### L2. 文字（無關鍵字）+ 圖片（有關鍵字）
**測試內容**：
1. 發送文字：「附上證明」
2. 發送圖片：包含「已轉帳 1000 元」

**預期結果**：
- ❌ 第一則訊息不觸發
- ✅ 第二則訊息觸發（OCR 辨識）

**實際結果**：


---

#### L3. 文字（有關鍵字）+ 圖片（無關鍵字）
**測試內容**：
1. 發送文字：「我匯款 1500 元了」
2. 發送圖片：一般圖片（無匯款資訊）

**預期結果**：
- ✅ 第一則訊息觸發
- ❌ 第二則訊息不觸發（OCR 無關鍵字）

**實際結果**：


---

### 測試組 M：OCR 錯誤處理（4 個案例）

#### M1. OCR 未啟用時發送圖片
**前置條件**：暫時停用 OCR（設定 `OCR_PROVIDER=none`）

**測試內容**：發送匯款截圖

**預期結果**：
- ✅ 日誌顯示：「🖼️ OCR 未啟用，跳過圖片辨識」
- ❌ 不觸發匯款通知
- ✅ 系統正常運作，無錯誤

**實際結果**：


---

#### M2. Google Vision API Key 錯誤
**前置條件**：設定錯誤的 API Key

**測試內容**：發送包含匯款文字的圖片

**預期結果**：
- ❌ OCR 處理失敗
- ✅ 日誌顯示：「❌ OCR 處理失敗: ...」
- ✅ 系統正常處理錯誤，回傳空字串
- ❌ 不觸發通知

**實際結果**：


---

#### M3. 網路連線錯誤
**前置條件**：模擬網路問題（可透過防火牆或斷網測試）

**測試內容**：發送圖片

**預期結果**：
- ❌ API 呼叫逾時
- ✅ 系統捕獲錯誤，不崩潰
- ✅ 日誌記錄錯誤訊息

**實際結果**：


---

#### M4. 空圖片或損毀圖片
**測試內容**：嘗試發送極小或損毀的圖片檔案

**預期結果**：
- ✅ 系統正常處理
- ✅ OCR 回傳空字串或錯誤
- ✅ 不觸發通知
- ✅ 無系統崩潰

**實際結果**：


---

## 📊 測試結果統計

### 通過率

| 測試組 | 案例數 | 通過 | 失敗 | 通過率 |
|--------|--------|------|------|--------|
| I. OCR 基本功能 | 5 |  |  |  |
| J. OCR + 匯款關鍵字 | 6 |  |  |  |
| K. OCR + 語意過濾 | 4 |  |  |  |
| L. 混合訊息 | 3 |  |  |  |
| M. OCR 錯誤處理 | 4 |  |  |  |
| **總計** | **22** |  |  |  |

### 已知問題


### OCR 辨識準確度

| 圖片類型 | 辨識成功率 | 備註 |
|---------|-----------|------|
| 清晰文字 |  |  |
| ATM 截圖 |  |  |
| 網銀截圖 |  |  |
| 手寫文字 |  |  |
| 模糊圖片 |  |  |

---

## 📝 測試執行記錄

**測試執行者**：  
**測試環境**：□ 本機 □ Docker / NAS  
**Google Vision API**：□ 已啟用  
**開始時間**：  
**結束時間**：  

---

## 💡 測試注意事項

### Google Vision API 配額

- 免費額度：每月 1,000 次請求
- 測試時注意配額用量
- 建議使用測試圖片重複測試

### 測試圖片準備

**建議測試圖片**：
1. 純文字截圖（使用記事本等）
2. 實際 ATM 轉帳截圖
3. 網路銀行轉帳截圖
4. 行動支付截圖
5. 手寫文字照片

**圖片製作工具**：
- macOS：截圖工具（Cmd+Shift+4）
- Windows：截圖工具（Win+Shift+S）
- 手機：直接拍照或截圖

### 隱私保護

⚠️ **注意**：測試時請：
- 不使用真實的個人敏感資訊
- 可遮蔽帳號、戶名等資訊
- 使用測試資料或模擬截圖

---

## 🔍 除錯提示

### OCR 辨識失敗

**檢查項目**：
1. API Key 是否正確
2. 網路連線是否正常
3. 圖片是否清晰可讀
4. 配額是否已用完

**日誌關鍵字**：
```
🖼️ OCR 未啟用
⚠️ 無法取得圖片內容
❌ OCR 處理失敗
📝 OCR 辨識文字
```

### 不觸發匯款通知

**可能原因**：
1. OCR 未辨識出關鍵字
2. 語意過濾攔截（延後/詢問等）
3. OCR 辨識失敗（回傳空字串）

**檢查方式**：
```bash
# 查看日誌
docker logs flb-attendance-system -f | grep -E "OCR|匯款"

# 查看語意過濾記錄
cat src/data/remittance-intent-log.json
```

---

**建立日期**：2025-11-21  
**最後更新**：2025-11-21
