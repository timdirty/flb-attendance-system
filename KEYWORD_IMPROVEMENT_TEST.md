# 🎯 匯款關鍵字改進測試

**改進日期**：2025-11-21 20:35  
**改進目標**：解決關鍵字太鬆散的問題，避免誤觸發

---

## 📊 改進前後對比

### ❌ 改進前（太鬆散）

**檢測邏輯**：只要包含「匯款」或「轉帳」就觸發

| 測試訊息 | 是否觸發 | 結果 |
|---------|---------|------|
| 我想問匯款方式 | ✅ 觸發 | ❌ **誤觸發** |
| 可以轉帳嗎？ | ✅ 觸發 | ❌ **誤觸發** |
| 怎麼使用ATM | ✅ 觸發 | ❌ **誤觸發** |
| 我已匯款500元 | ✅ 觸發 | ✅ **正確** |
| 轉帳完成 | ✅ 觸發 | ✅ **正確** |

**問題**：誤觸發率 **60%**，太多假陽性！

---

### ✅ 改進後（精準檢測）

**檢測邏輯**：雙重檢測機制

#### 策略 1（優先級最高）：明確完成短語

直接包含這些短語即觸發：
```
已匯款、已轉帳、轉帳完成、匯款完成、已轉、已匯、
轉好了、匯好了、已付款、付款完成
```

#### 策略 2：基礎關鍵字 + 完成詞

**必須同時包含兩者**：

**基礎關鍵字**（匯款動作詞）：
```
匯款、轉帳、ATM轉帳、銀行轉帳
```

**+ 完成詞**（表示已完成）：
```
已、完成、好了、成功、剛剛、剛才、剛、已經、轉好、匯好
```

---

## 🧪 測試案例

### 分類 1：應該觸發的（✅ True Positive）

| 測試訊息 | 觸發策略 | 預期結果 | 原因 |
|---------|---------|---------|------|
| 我已匯款500元 | 策略1 | ✅ 觸發 | 包含「已匯款」 |
| 轉帳完成 | 策略1 | ✅ 觸發 | 包含「轉帳完成」 |
| 已轉500 | 策略1 | ✅ 觸發 | 包含「已轉」 |
| 剛剛匯款了 | 策略2 | ✅ 觸發 | 「匯款」+「剛剛」 |
| 我已經轉帳給你 | 策略2 | ✅ 觸發 | 「轉帳」+「已經」 |
| ATM轉好了 | 策略2 | ✅ 觸發 | 「ATM轉帳」+「轉好」 |
| 銀行轉帳成功 | 策略2 | ✅ 觸發 | 「銀行轉帳」+「成功」 |
| 匯款好了喔 | 策略2 | ✅ 觸發 | 「匯款」+「好了」 |
| 已付款完成 | 策略1 | ✅ 觸發 | 包含「已付款」或「付款完成」 |
| 匯好了500元 | 策略2 | ✅ 觸發 | 「匯款」+「匯好」 |

---

### 分類 2：不應觸發的（✅ True Negative）

| 測試訊息 | 檢測結果 | 預期結果 | 原因 |
|---------|---------|---------|------|
| 我想問匯款方式 | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「詢問」 |
| 可以轉帳嗎？ | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「疑問」 |
| 怎麼使用ATM | ❌ 不符合 | ✅ 不觸發 | 無「完成詞」 |
| 匯款帳號是多少 | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「詢問」 |
| 等等轉帳給你 | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「延後」 |
| 明天會匯款 | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「延後」 |
| 還沒匯款 | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「否定」 |
| 如何匯款 | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「詢問」 |
| 準備匯款 | ❌ 不符合 | ✅ 不觸發 | 無「完成詞」 |
| 要轉帳了 | ❌ 不符合 | ✅ 不觸發 | 無「完成詞」（「了」不在清單） |

---

### 分類 3：邊緣案例測試

| 測試訊息 | 檢測結果 | 預期結果 | 說明 |
|---------|---------|---------|------|
| 我已匯款 但還沒成功 | ⭕ 延後 | ✅ 不觸發 | 語意過濾：「否定」 |
| 已匯款500元 明天會到 | ✅ 觸發 | ✅ 觸發 | 包含「已匯款」，延後詞不影響 |
| 匯款嗎？我已經匯了 | ⭕ 延後？ | 🤔 待測 | 包含疑問詞，但後面已完成 |
| ATM | ❌ 不符合 | ✅ 不觸發 | 只有基礎詞，無完成詞 |
| 已 | ❌ 不符合 | ✅ 不觸發 | 只有完成詞，無基礎詞 |

---

## 🔄 改進成果預測

### 精準度提升

| 指標 | 改進前 | 改進後 | 提升 |
|-----|-------|-------|------|
| **準確率** | ~40% | ~95%+ | **+138%** |
| **誤觸發率** | 60% | <5% | **-92%** |
| **漏檢率** | <5% | <5% | 持平 |

### 檢測流程

```
收到訊息
  ↓
移除空白，轉為小寫（正規化）
  ↓
【策略 1】是否包含明確完成短語？
  ├─ 是 → ✅ 符合條件 → 進入語意過濾
  └─ 否 → 繼續下一步
        ↓
【策略 2】是否同時包含「基礎關鍵字」+ 「完成詞」？
  ├─ 是 → ✅ 符合條件 → 進入語意過濾
  └─ 否 → ❌ 不符合，跳過匯款處理
        ↓
【語意過濾】檢查延後/否定/詢問/疑問
  ├─ 有延後意圖 → ⭕ 延後處理，發送延後回覆
  └─ 無延後意圖 → ✅ 觸發匯款通知
        ↓
發送通知給管理員 + 回覆用戶
```

---

## 📋 實際測試執行表

### 測試環境

- [ ] Docker 容器已重啟
- [ ] Synology Drive 已同步
- [ ] LINE Bot 運行正常
- [ ] 日誌監控已開啟

### 測試執行

#### ✅ 應觸發案例（10個）

| # | 測試訊息 | 實際結果 | 狀態 | 備註 |
|---|---------|---------|------|------|
| 1 | 我已匯款500元 | | ⬜ | 策略1：「已匯款」 |
| 2 | 轉帳完成 | | ⬜ | 策略1：「轉帳完成」 |
| 3 | 已轉500 | | ⬜ | 策略1：「已轉」 |
| 4 | 剛剛匯款了 | | ⬜ | 策略2：「匯款」+「剛剛」 |
| 5 | 我已經轉帳給你 | | ⬜ | 策略2：「轉帳」+「已經」 |
| 6 | ATM轉好了 | | ⬜ | 策略2：「ATM」+「轉好」 |
| 7 | 銀行轉帳成功 | | ⬜ | 策略2：「銀行轉帳」+「成功」 |
| 8 | 匯款好了喔 | | ⬜ | 策略2：「匯款」+「好了」 |
| 9 | 已付款完成 | | ⬜ | 策略1：「付款完成」 |
| 10 | 匯好了500元 | | ⬜ | 策略2：「匯款」+「匯好」 |

#### ❌ 不應觸發案例（10個）

| # | 測試訊息 | 實際結果 | 狀態 | 備註 |
|---|---------|---------|------|------|
| 1 | 我想問匯款方式 | | ⬜ | 應延後（詢問） |
| 2 | 可以轉帳嗎？ | | ⬜ | 應延後（疑問） |
| 3 | 怎麼使用ATM | | ⬜ | 不符合（無完成詞） |
| 4 | 匯款帳號是多少 | | ⬜ | 應延後（詢問） |
| 5 | 等等轉帳給你 | | ⬜ | 應延後（延後） |
| 6 | 明天會匯款 | | ⬜ | 應延後（延後） |
| 7 | 還沒匯款 | | ⬜ | 應延後（否定） |
| 8 | 如何匯款 | | ⬜ | 應延後（詢問） |
| 9 | 準備匯款 | | ⬜ | 不符合（無完成詞） |
| 10 | 要轉帳了 | | ⬜ | 不符合（無完成詞） |

---

## 🔍 日誌檢查重點

### 改進後的日誌格式

```javascript
🔍 檢查匯款關鍵字: {
  targetTextPreview: '我已匯款500元',
  hasExplicitPhrase: true,        // ✅ 包含明確短語
  hasBaseKeyword: true,            // ✅ 包含基礎關鍵字
  hasCompletionWord: true,         // ✅ 包含完成詞
  hasBothKeywordAndCompletion: true, // ✅ 同時包含兩者
  hitKeywords: true,               // ✅ 最終判斷：觸發
  intentAnalysis: {
    shouldDefer: false,            // ✅ 不延後
    reason: null
  }
}
✅ 觸發匯款通知處理...
```

### 不觸發案例日誌

```javascript
🔍 檢查匯款關鍵字: {
  targetTextPreview: '我想問匯款方式',
  hasExplicitPhrase: false,        // ❌ 無明確短語
  hasBaseKeyword: true,            // ⚠️ 有基礎關鍵字
  hasCompletionWord: false,        // ❌ 無完成詞
  hasBothKeywordAndCompletion: false, // ❌ 不同時包含
  hitKeywords: false,              // ❌ 最終判斷：不觸發
  intentAnalysis: {
    shouldDefer: true,             // ⭕ 延後
    reason: 'inquiry'              // 原因：詢問
  }
}
⚠️ 匯款語意判斷為延後/詢問，暫不觸發通知
```

---

## 🚀 部署步驟

### 1. 確認檔案已同步

```bash
# 確認修改的檔案
ls -lh src/config.js
ls -lh server.js

# 確認修改時間是最新的
stat -f "%Sm" src/config.js
stat -f "%Sm" server.js
```

### 2. SSH 連線到 NAS

```bash
ssh your-username@your-nas-ip
```

### 3. 進入專案目錄

```bash
cd /volume1/homes/ctctim14/樂程坊計畫/課程資料/Cursor/FLB簽到系統（line）
```

### 4. 重啟 Docker 容器

```bash
# 重啟容器
docker-compose restart

# 等待 5 秒
sleep 5

# 查看日誌
docker logs flb-line-bot -f --tail 50
```

### 5. 開始測試

在 LINE 中發送測試訊息，觀察日誌輸出。

---

## ✅ 驗證清單

### 功能驗證

- [ ] ✅ 觸發案例：「我已匯款500元」→ 觸發通知
- [ ] ✅ 觸發案例：「轉帳完成」→ 觸發通知
- [ ] ❌ 不觸發案例：「我想問匯款方式」→ 不觸發
- [ ] ❌ 不觸發案例：「可以轉帳嗎？」→ 不觸發
- [ ] ❌ 不觸發案例：「怎麼使用ATM」→ 不觸發

### Flex Message 驗證

- [ ] URL scheme 錯誤已修復
- [ ] 管理員成功收到 Flex Message
- [ ] Flex Message 顯示正常（金額、時間、用戶名）
- [ ] 按鈕功能正常

### 日誌驗證

- [ ] 日誌顯示 `hasExplicitPhrase` 狀態
- [ ] 日誌顯示 `hasBaseKeyword` 狀態
- [ ] 日誌顯示 `hasCompletionWord` 狀態
- [ ] 日誌顯示 `hasBothKeywordAndCompletion` 狀態
- [ ] 最終 `hitKeywords` 判斷正確

---

## 📊 測試結果記錄

### 測試執行時間

- **開始時間**：________
- **結束時間**：________
- **測試人員**：________

### 結果統計

| 類型 | 測試數量 | 通過數量 | 失敗數量 | 通過率 |
|------|---------|---------|---------|--------|
| 應觸發案例 | 10 | ___ | ___ | ___% |
| 不應觸發案例 | 10 | ___ | ___ | ___% |
| **總計** | **20** | **___** | **___** | **___%** |

### 發現的問題

1. ____________________________________________
2. ____________________________________________
3. ____________________________________________

---

## 🎉 預期成果

改進後，系統應該：

1. ✅ **大幅降低誤觸發**
   - 「匯款方式」、「可以轉帳嗎」不再觸發

2. ✅ **保持高準確度**
   - 「我已匯款」、「轉帳完成」正常觸發

3. ✅ **更智能的判斷**
   - 同時考慮「動作詞」+「完成詞」

4. ✅ **更詳細的日誌**
   - 清楚顯示每個檢測步驟的結果

---

**建立時間**：2025-11-21 20:35  
**文檔版本**：v1.0  
**狀態**：✅ 待測試
