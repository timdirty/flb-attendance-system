#!/usr/bin/env node

/**
 * ğŸ§ª OCR é‡‘é¡æå–æ¸¬è©¦è…³æœ¬
 * 
 * æ¸¬è©¦å„ç¨®å¸¸è¦‹çš„å°ç£éŠ€è¡Œè½‰å¸³æ ¼å¼
 * ç¢ºä¿é‡‘é¡æå–é‚è¼¯æ­£ç¢ºé‹ä½œ
 */

// è¤‡è£½ server.js ä¸­çš„é‡‘é¡æå–å‡½æ•¸
function parseAmountFromText(text) {
    if (!text) return null;
    
    // ç­–ç•¥ 1ï¼šå„ªå…ˆåŒ¹é…æœ‰æ˜ç¢ºé‡‘é¡é—œéµå­—çš„æ•¸å­—
    const keywordPatterns = [
        // æ”¯æ´ "è½‰å¸³é‡‘é¡ TWD1,000.00" æ ¼å¼ï¼ˆä¿ç•™é€—è™Ÿå’Œå°æ•¸é»ï¼‰
        /(?:é‡‘é¡|è½‰å¸³é‡‘é¡|åŒ¯æ¬¾é‡‘é¡|ä»˜æ¬¾é‡‘é¡|ç¹³è²»é‡‘é¡|æ‡‰ç¹³é‡‘é¡|è½‰å‡ºé‡‘é¡|è½‰å…¥é‡‘é¡|äº¤æ˜“é‡‘é¡)[\s:ï¼š]*(?:TWD|NTD|NT\$|USD|\$)?[\s]*(\d{1,}(?:,\d{3})*(?:\.\d{2})?)/i,
        // æ”¯æ´ "NT$ 1000" æ ¼å¼
        /(?:NT\$|NT|USD|TWD|NTD|å°å¹£)[\s]*(\d{1,}(?:,\d{3})*(?:\.\d{2})?)/i,
        // æ”¯æ´ "1000å…ƒ" æ ¼å¼
        /(\d{3,})\s*(?:å…ƒ|å¡Š)/i
    ];
    
    for (const pattern of keywordPatterns) {
        const match = text.match(pattern);
        if (match && match[1]) {
            // ç§»é™¤é€—è™Ÿå’Œå°æ•¸é»å¾Œçš„éƒ¨åˆ†ï¼Œåªä¿ç•™æ•´æ•¸
            let amount = match[1].replace(/,/g, '').split('.')[0];
            
            // æ’é™¤æ—¥æœŸæ•¸å­—ï¼ˆåªæ’é™¤ 2000-2099 ä¹‹é–“çš„ 4 ä½æ•¸å¹´ä»½ï¼‰
            const numAmount = parseInt(amount);
            if (amount.length === 4 && numAmount >= 2000 && numAmount <= 2099) {
                // ç¢ºå®šæ˜¯å¹´ä»½ï¼Œè·³é
                continue;
            }
            return amount;
        }
    }
    
    // ç§»é™¤é€—è™Ÿç”¨æ–¼ç­–ç•¥ 2 å’Œ 3
    const cleanText = text.replace(/,/g, '');

    // å…ˆç§»é™¤å¸¸è¦‹çš„ã€ŒéŠ€è¡Œä»£ç¢¼ + é•·å¸³è™Ÿã€æ ¼å¼ï¼Œé¿å…æŠŠ 812 é€™é¡éŠ€è¡Œä»£ç¢¼èª¤åˆ¤ç‚ºé‡‘é¡
    // ä¾‹å¦‚ï¼š"(812)0028881014624669"ã€"812-0028881014624669"ã€"8120028881014624669"
    let sanitizedText = cleanText
        // æ ¼å¼ä¸€ï¼š(812)0028881014624669
        .replace(/\(\d{3}\)\d{5,}/g, ' ')
        // æ ¼å¼äºŒï¼š812-0028881014624669
        .replace(/\b\d{3}-\d{5,}\b/g, ' ')
        // æ ¼å¼ä¸‰ï¼š8120028881014624669ï¼ˆ3 ç¢¼é–‹é ­å¾Œæ¥ 7 ç¢¼ä»¥ä¸Šï¼‰
        .replace(/\b\d{3}\d{7,}\b/g, ' ')
        // ğŸ†• æ ¼å¼å››ï¼šæ’é™¤ã€Œæœ«äº”ç¢¼XXXXXã€ã€Œå¾Œäº”ç¢¼XXXXXã€ã€Œæœ«Xç¢¼XXXXXã€ç­‰å¸³è™Ÿå°¾ç¢¼ï¼ˆæ”¯æ´ä¸­æ–‡æ•¸å­—ï¼‰
        .replace(/(?:æœ«|å¾Œ|å°¾|æœ€å¾Œ).{0,5}ç¢¼[\s]*\d{3,}/gi, ' ')
        // ğŸ†• æ ¼å¼äº”ï¼šæ’é™¤ã€Œå¸³è™ŸXXXXXã€ã€Œå¸³è™Ÿå°¾æ•¸XXXXXã€
        .replace(/å¸³è™Ÿ(?:å°¾æ•¸|å¾Œ[\s]*\d+[\s]*ç¢¼)?[\s]*\d{3,}/gi, ' ');
    
    // ç­–ç•¥ 2ï¼šåŒ¹é…ç¨ç«‹çš„æ•¸å­—ï¼ˆé¿å…æ—¥æœŸæ ¼å¼ï¼‰
    // æ’é™¤ YYYY-MM-DD æˆ– YYYY/MM/DD æ ¼å¼ä¸­çš„æ•¸å­—
    const amounts = sanitizedText.match(/(?<![\d-\/])\d{3,}(?![\d-\/])/g);
    if (amounts && amounts.length > 0) {
        // éæ¿¾æ‰å¯èƒ½æ˜¯å¹´ä»½çš„æ•¸å­—ï¼ˆ2000-2099ï¼‰
        const validAmounts = amounts.filter(num => {
            const n = parseInt(num);
            return !(n >= 2000 && n <= 2099);
        });
        
        if (validAmounts.length > 0) {
            // è¿”å›ç¬¬ä¸€å€‹æœ‰æ•ˆé‡‘é¡
            return validAmounts[0];
        }
    }
    
    // ç­–ç•¥ 3ï¼šå›é€€åˆ°åŸå§‹åŒ¹é…ï¼ˆä½†æ’é™¤å¹´ä»½ï¼‰
    const fallbackMatch = sanitizedText.match(/\d{3,}/g);
    if (fallbackMatch && fallbackMatch.length > 0) {
        // æ‰¾ç¬¬ä¸€å€‹ä¸æ˜¯å¹´ä»½çš„æ•¸å­—
        for (const num of fallbackMatch) {
            const n = parseInt(num);
            if (n < 2000 || n > 2099) {
                return num;
            }
        }
    }
    
    return null;
}

// æ¸¬è©¦æ¡ˆä¾‹ï¼ˆåŸºæ–¼çœŸå¯¦å°ç£éŠ€è¡Œè½‰å¸³æ ¼å¼ï¼‰
const testCases = [
    // ==================== å°ç£å¸¸è¦‹éŠ€è¡Œæ ¼å¼ ====================
    
    // 1. å°ç£éŠ€è¡Œï¼ˆTWD å‰ç¶´ï¼‰
    {
        name: 'å°ç£éŠ€è¡Œ - TWD æ ¼å¼',
        ocrText: `è½‰å¸³çµæœ
äº¤æ˜“æˆåŠŸ
å°å¹£è½‰å¸³
è½‰å‡ºå¸³è™Ÿ å¤¢ä¸–ä»£æ´»æœŸå„²è“„å­˜æ¬¾
.........88888 ***
è½‰å…¥éŠ€è¡Œ 052 æ¸£æ‰“éŠ€è¡Œ 8888888888
å¸³è™Ÿ
è½‰å¸³é‡‘é¡ TWD1,000.00
è½‰å‡ºå¸³è™Ÿ TWD R
é¤˜é¡
è½‰å¸³æ—¥æœŸ å³æ™‚2024/`,
        expected: '1000',
        description: 'æ¸¬è©¦ TWD å‰ç¶´ + é€—è™Ÿ + å°æ•¸é»'
    },
    
    // 2. å¯Œé‚¦éŠ€è¡Œ
    {
        name: 'å¯Œé‚¦éŠ€è¡Œ - æ¨™æº–æ ¼å¼',
        ocrText: `äº¤æ˜“çµæœè½‰å¸³æˆåŠŸ
2025-11-22 15:54:07
1935***3957
012 å°åŒ—å¯Œé‚¦
äº¤æ˜“æ™‚é–“
è½‰å‡ºå¸³è™Ÿ
è½‰å…¥éŠ€è¡Œ
è½‰å…¥å¸³è™Ÿ
è½‰å¸³é‡‘é¡
2,250
8211***0220178`,
        expected: '2250',
        description: 'æ¸¬è©¦ç´”æ•¸å­— + é€—è™Ÿæ ¼å¼'
    },
    
    // 3. ä¸­åœ‹ä¿¡è¨—
    {
        name: 'ä¸­åœ‹ä¿¡è¨— - NT$ æ ¼å¼',
        ocrText: `è½‰å¸³æˆåŠŸ
è½‰å¸³é‡‘é¡ï¼šNT$ 5,000
è½‰å…¥å¸³è™Ÿï¼š822-123456789
æ‰‹çºŒè²»ï¼š0å…ƒ
äº¤æ˜“æ™‚é–“ï¼š2024/11/22 14:30`,
        expected: '5000',
        description: 'æ¸¬è©¦ NT$ å‰ç¶´'
    },
    
    // 4. åœ‹æ³°ä¸–è¯
    {
        name: 'åœ‹æ³°ä¸–è¯ - å…ƒå­—å¾Œç¶´',
        ocrText: `è½‰å¸³çµæœ
ç‹€æ…‹ï¼šæˆåŠŸ
é‡‘é¡ï¼š3500å…ƒ
å—æ¬¾äººï¼šå¼µä¸‰
å¸³è™Ÿï¼š013-1234567890
æ™‚é–“ï¼š2024-11-22`,
        expected: '3500',
        description: 'æ¸¬è©¦ã€Œå…ƒã€å­—å¾Œç¶´'
    },
    
    // 5. ç‰å±±éŠ€è¡Œ
    {
        name: 'ç‰å±±éŠ€è¡Œ - NTD æ ¼å¼',
        ocrText: `äº¤æ˜“æ˜ç´°
äº¤æ˜“æˆåŠŸ
è½‰å¸³é‡‘é¡ NTD2,800.00
è½‰å…¥éŠ€è¡Œ 808 ç‰å±±éŠ€è¡Œ
è½‰å…¥å¸³è™Ÿ 0123456789012
äº¤æ˜“åºè™Ÿ 20241122001`,
        expected: '2800',
        description: 'æ¸¬è©¦ NTD å‰ç¶´'
    },
    
    // 6. å°æ–°éŠ€è¡Œ
    {
        name: 'å°æ–°éŠ€è¡Œ - å°å¹£æ ¼å¼',
        ocrText: `è½‰å¸³äº¤æ˜“
äº¤æ˜“ç‹€æ…‹ï¼šå®Œæˆ
å°å¹£ 1,500
æ”¶æ¬¾éŠ€è¡Œï¼š812 å°æ–°éŠ€è¡Œ
æ”¶æ¬¾å¸³è™Ÿï¼š9876543210
æ—¥æœŸï¼š2024/11/22 15:00`,
        expected: '1500',
        description: 'æ¸¬è©¦ã€Œå°å¹£ã€é—œéµå­—'
    },
    
    // ==================== é‚Šç•Œæ¡ˆä¾‹æ¸¬è©¦ ====================
    
    // 7. å¤§é¡é‡‘é¡
    {
        name: 'å¤§é¡é‡‘é¡æ¸¬è©¦',
        ocrText: `åŒ¯æ¬¾æˆåŠŸ
é‡‘é¡ï¼šNT$ 123,456
å—æ¬¾äººï¼šå…¬å¸åç¨±
æ™‚é–“ï¼š2024-11-22`,
        expected: '123456',
        description: 'æ¸¬è©¦å…­ä½æ•¸å¤§é¡'
    },
    
    // 8. å°é¡é‡‘é¡ï¼ˆä½æ–¼1000ï¼‰
    {
        name: 'å°é¡é‡‘é¡æ¸¬è©¦',
        ocrText: `è½‰å¸³å®Œæˆ
è½‰å¸³é‡‘é¡ï¼š500å…ƒ
æ‰‹çºŒè²»ï¼š0å…ƒ`,
        expected: '500',
        description: 'æ¸¬è©¦ä¸‰ä½æ•¸å°é¡'
    },
    
    // 9. æœ‰å¹´ä»½å¹²æ“¾
    {
        name: 'å¹´ä»½å¹²æ“¾æ¸¬è©¦',
        ocrText: `äº¤æ˜“çµæœ
äº¤æ˜“æˆåŠŸ
2025-11-22 15:54:07
è½‰å¸³é‡‘é¡ 3,300
å¸³è™Ÿ 1234567890`,
        expected: '3300',
        description: 'æ¸¬è©¦æ’é™¤å¹´ä»½ 2025'
    },
    
    // 10. å¤šå€‹æ•¸å­—å¹²æ“¾
    {
        name: 'å¤šæ•¸å­—å¹²æ“¾æ¸¬è©¦',
        ocrText: `è½‰å¸³çµæœ
å¸³è™Ÿï¼š1234567890
è½‰å¸³é‡‘é¡ï¼šNT$ 4,200
æ‰‹çºŒè²»ï¼š15å…ƒ
åºè™Ÿï¼š20241122001`,
        expected: '4200',
        description: 'æ¸¬è©¦åœ¨å¤šå€‹æ•¸å­—ä¸­æå–æ­£ç¢ºé‡‘é¡'
    },
    
    // 11. ç„¡ç©ºæ ¼ç·Šè²¼æ ¼å¼
    {
        name: 'ç·Šè²¼æ ¼å¼æ¸¬è©¦',
        ocrText: `è½‰å¸³æˆåŠŸ
é‡‘é¡:TWD6,800.00
å¸³è™Ÿ:1234567890`,
        expected: '6800',
        description: 'æ¸¬è©¦å†’è™Ÿå¾Œç„¡ç©ºæ ¼'
    },
    
    // 12. å…¨å½¢ç¬¦è™Ÿ
    {
        name: 'å…¨å½¢ç¬¦è™Ÿæ¸¬è©¦',
        ocrText: `è½‰å¸³çµæœ
é‡‘é¡ï¼šï¼—ï¼Œï¼’ï¼ï¼å…ƒ
ç‹€æ…‹ï¼šæˆåŠŸ`,
        expected: null, // å…¨å½¢æ•¸å­—ç„¡æ³•åŒ¹é…ï¼Œé æœŸç‚º null
        description: 'æ¸¬è©¦å…¨å½¢æ•¸å­—ï¼ˆæ‡‰ç„¡æ³•åŒ¹é…ï¼‰'
    },
    
    // 13. USD å¤–å¹£æ ¼å¼
    {
        name: 'USD å¤–å¹£æ¸¬è©¦',
        ocrText: `International Transfer
Amount: USD 1,500.00
Status: Completed`,
        expected: '1500',
        description: 'æ¸¬è©¦ USD å¤–å¹£æ ¼å¼'
    },
    
    // 14. æ··åˆæ ¼å¼
    {
        name: 'æ··åˆæ ¼å¼æ¸¬è©¦',
        ocrText: `è½‰å¸³æ˜ç´°
2024/11/22 16:30
å¸³è™Ÿ 987654321
åŒ¯æ¬¾é‡‘é¡ NT$9,999
æ‰‹çºŒè²» 30å…ƒ`,
        expected: '9999',
        description: 'æ¸¬è©¦æ··åˆå¤šç¨®æ ¼å¼'
    },
    
    // ==================== éŒ¯èª¤æ¡ˆä¾‹ï¼ˆæ‡‰è©²ç„¡æ³•æå–ï¼‰ ====================
    
    // 15. åªæœ‰æ—¥æœŸç„¡é‡‘é¡
    {
        name: 'ç„¡é‡‘é¡æ¸¬è©¦',
        ocrText: `è½‰å¸³è¨˜éŒ„
æ—¥æœŸï¼š2024/11/22
å¸³è™Ÿï¼š1234567890
ç‹€æ…‹ï¼šè™•ç†ä¸­`,
        expected: null,
        description: 'ç„¡æ˜ç¢ºé‡‘é¡é—œéµå­—æ™‚æ‡‰å›å‚³ nullï¼ˆä¸å†æ‹¿å¸³è™Ÿç•¶é‡‘é¡ï¼‰'
    },
    
    // 16. é‡‘é¡å°‘æ–¼3ä½æ•¸
    {
        name: 'å…©ä½æ•¸é‡‘é¡',
        ocrText: `æ‰‹çºŒè²»
é‡‘é¡ï¼š50å…ƒ`,
        expected: '50', // ã€Œå…ƒã€å¾Œç¶´å¯ä»¥åŒ¹é…ä»»æ„ä½æ•¸
        description: 'æ¸¬è©¦å…©ä½æ•¸ï¼ˆæœ‰ã€Œå…ƒã€å¾Œç¶´å¯åŒ¹é…ï¼‰'
    },
    {
        name: 'éŠ€è¡Œä»£ç¢¼ 812 + è½‰å‡ºé‡‘é¡ $300',
        ocrText: `è½‰å¸³
äº¤æ˜“æˆåŠŸ
è½‰å‡ºå¸³è™Ÿ (812)0028881014624669
è½‰å…¥å¸³è™Ÿ (012)0082110000220178
äº¤æ˜“æ—¥æœŸ 2025/11/23 16:34:42
è½‰å‡ºé‡‘é¡ $300`,
        expected: '300',
        description: 'æ‡‰å¿½ç•¥ 812 éŠ€è¡Œä»£ç¢¼èˆ‡é•·å¸³è™Ÿï¼ŒæŠ“åˆ°è½‰å‡ºé‡‘é¡ $300'
    },
    
    // ğŸ†• 17. æœ«äº”ç¢¼æ¸¬è©¦ï¼ˆçœŸå¯¦æ¡ˆä¾‹ï¼‰
    {
        name: 'æœ«äº”ç¢¼ 11204 æ‡‰è¢«æ’é™¤',
        ocrText: `è¨‚é‡‘å·²åŒ¯ï¼Œæœ«äº”ç¢¼11204ï¼Œæˆ¶åç§ç«‹å“ç›Ÿæ–‡ç†è£œç¿’ç­ï¼Œç„¶å¾Œå†è·Ÿä½ ç¢ºèªä¸€ä¸‹èª²ç¨‹èˆ‡æ™‚é–“ï¼Œ1/26-30minecraftå‰µæ„ç¨‹å¼ï¼Œ2/2-6é›·å°„åˆ‡å‰²å‰µä½œï¼Œæ¯å¤©ä¸Šèª²æ™‚é–“ç‚ºä¸‹åˆ2ï¼š15-3ï¼š45`,
        expected: null,
        description: 'æ‡‰æ’é™¤ã€Œæœ«äº”ç¢¼11204ã€ï¼Œä¸æ‡‰èª¤åˆ¤ç‚ºé‡‘é¡ 11,204'
    },
    {
        name: 'å¾Œäº”ç¢¼æ¸¬è©¦',
        ocrText: `å·²è½‰å¸³ï¼Œå¾Œäº”ç¢¼ 99888`,
        expected: null,
        description: 'æ‡‰æ’é™¤ã€Œå¾Œäº”ç¢¼99888ã€'
    },
    {
        name: 'å¸³è™Ÿå°¾æ•¸æ¸¬è©¦',
        ocrText: `åŒ¯æ¬¾å®Œæˆï¼Œå¸³è™Ÿå°¾æ•¸12345`,
        expected: null,
        description: 'æ‡‰æ’é™¤ã€Œå¸³è™Ÿå°¾æ•¸12345ã€'
    }
];

// åŸ·è¡Œæ¸¬è©¦
console.log('ğŸ§ª é–‹å§‹åŸ·è¡Œ OCR é‡‘é¡æå–æ¸¬è©¦\n');
console.log('=' .repeat(80));

let passedCount = 0;
let failedCount = 0;
const failures = [];

testCases.forEach((testCase, index) => {
    const result = parseAmountFromText(testCase.ocrText);
    const passed = result === testCase.expected;
    
    if (passed) {
        console.log(`\nâœ… æ¸¬è©¦ ${index + 1}/${testCases.length}: ${testCase.name}`);
        console.log(`   æè¿°ï¼š${testCase.description}`);
        console.log(`   é æœŸï¼š${testCase.expected} | å¯¦éš›ï¼š${result}`);
        passedCount++;
    } else {
        console.log(`\nâŒ æ¸¬è©¦ ${index + 1}/${testCases.length}: ${testCase.name}`);
        console.log(`   æè¿°ï¼š${testCase.description}`);
        console.log(`   é æœŸï¼š${testCase.expected} | å¯¦éš›ï¼š${result}`);
        console.log(`   OCR æ–‡å­—é è¦½ï¼š${testCase.ocrText.slice(0, 100)}...`);
        failedCount++;
        failures.push({
            name: testCase.name,
            expected: testCase.expected,
            actual: result,
            description: testCase.description
        });
    }
});

console.log('\n' + '='.repeat(80));
console.log('\nğŸ“Š æ¸¬è©¦çµæœçµ±è¨ˆ');
console.log(`   ç¸½æ¸¬è©¦æ•¸ï¼š${testCases.length}`);
console.log(`   âœ… é€šéï¼š${passedCount} (${(passedCount / testCases.length * 100).toFixed(1)}%)`);
console.log(`   âŒ å¤±æ•—ï¼š${failedCount} (${(failedCount / testCases.length * 100).toFixed(1)}%)`);

if (failures.length > 0) {
    console.log('\nâŒ å¤±æ•—æ¡ˆä¾‹è©³æƒ…ï¼š');
    failures.forEach((failure, idx) => {
        console.log(`\n${idx + 1}. ${failure.name}`);
        console.log(`   ${failure.description}`);
        console.log(`   é æœŸï¼š${failure.expected}`);
        console.log(`   å¯¦éš›ï¼š${failure.actual}`);
    });
}

console.log('\n' + '='.repeat(80));

// è¿”å›é€€å‡ºç¢¼
process.exit(failedCount > 0 ? 1 : 0);
