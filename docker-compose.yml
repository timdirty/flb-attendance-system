version: '3.8'

services:
  flb-line-bot:
    build: .
    image: flb-line-bot:latest
    container_name: flb-line-bot
    restart: unless-stopped
    
    ports:
      - "3010:3010"
    
    environment:
      - NODE_ENV=production
      - PORT=3010
      - TZ=Asia/Taipei
      
      # 系統 URL（用於 Flex Message 圖片等）
      - SYSTEM_URL=${SYSTEM_URL:-https://flbbot.funlearnbar.synology.me}
      
      # LINE Bot 設定（從 .env 讀取）
      - LINE_CHANNEL_ACCESS_TOKEN=${LINE_CHANNEL_ACCESS_TOKEN}
      - LINE_CHANNEL_SECRET=${LINE_CHANNEL_SECRET}
      - LINE_USER_ID=${LINE_USER_ID}
      - LINE_CHANNEL_ACCESS_TOKEN_2=${LINE_CHANNEL_ACCESS_TOKEN_2}
      - ENABLE_DUAL_BOT=${ENABLE_DUAL_BOT:-false}
      
      # 管理員設定
      - ADMIN_USER_IDS=${ADMIN_USER_IDS}
      - ENABLE_MULTI_ADMINS=${ENABLE_MULTI_ADMINS:-true}
      
      # Google Sheets 設定
      - GOOGLE_SHEETS_API=${GOOGLE_SHEETS_API}
      - GOOGLE_SHEETS_COOKIE=${GOOGLE_SHEETS_COOKIE}
      
      # 匯款通知設定
      - REMITTANCE_GROUP_ID=${REMITTANCE_GROUP_ID}
      - REMITTANCE_KEYWORDS=${REMITTANCE_KEYWORDS}
      - REMITTANCE_COMPLETION_WORDS=${REMITTANCE_COMPLETION_WORDS}
      - REMITTANCE_EXPLICIT_PHRASES=${REMITTANCE_EXPLICIT_PHRASES}
      
      # OCR 設定
      - OCR_PROVIDER=${OCR_PROVIDER}
      - GOOGLE_VISION_API_KEY=${GOOGLE_VISION_API_KEY}

      # AI / Gemini 設定
      - AI_PROVIDER=${AI_PROVIDER}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - GEMINI_MODEL=${GEMINI_MODEL}
      
      # 官方 LINE 帳號設定
      - LINE_OFFICIAL_BIZ_ID=${LINE_OFFICIAL_BIZ_ID}
      - LINE_OFFICIAL_CHAT_BASE=${LINE_OFFICIAL_CHAT_BASE}
      - LINE_OFFICIAL_BOT_USER_ID=${LINE_OFFICIAL_BOT_USER_ID}
      - LINE_OFFICIAL_MANAGER_ID=${LINE_OFFICIAL_MANAGER_ID}
      
      # Notion 記帳整合
      - NOTION_API_TOKEN=${NOTION_API_TOKEN}
      - NOTION_INCOME_DATABASE_ID=${NOTION_INCOME_DATABASE_ID}
      - NOTION_INCOME_CATEGORY_ID=${NOTION_INCOME_CATEGORY_ID}
      - NOTION_INCOME_ACCOUNT_ID=${NOTION_INCOME_ACCOUNT_ID}
      - NOTION_INCOME_TYPE=${NOTION_INCOME_TYPE}
      - NOTION_INCOME_HAS_MEMO_FIELD=${NOTION_INCOME_HAS_MEMO_FIELD}
      
      # Webhook 轉發設定
      - WEBHOOK_FORWARD_TARGETS=${WEBHOOK_FORWARD_TARGETS}
      - WEBHOOK_FORWARD_LOG=${WEBHOOK_FORWARD_LOG:-true}
    
    volumes:
      # 資料持久化（使用絕對路徑或相對路徑）
      - ./data:/app/data
      # 系統資料（包含 webhook 配置、管理員設定等）
      - ./src/data:/app/src/data
      # 日誌
      - ./logs:/app/logs
    
    networks:
      - flb-network
    
    # 資源限制（Synology NAS 不支援 CPUs 限制）
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1.0'
    #       memory: 512M
    #     reservations:
    #       memory: 256M
    
    # 健康檢查
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3010/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      start_period: 40s
      retries: 3

networks:
  flb-network:
    driver: bridge

